<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ASSISTENTE CANARIS</title>

  <style>
    :root{
      --bg:#0b0b0b;
      --card:#141414;
      --text:#f2f2f2;
      --muted:#9ca3af;
      --accent:#22c55e;
      --border:#2a2a2a;
      --radius:18px;
      --shadow:0 10px 25px rgba(0,0,0,.35);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:linear-gradient(180deg,#050505,#0b0b0b);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
    }

    .app{
      width:min(520px,100%);
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
    }

    /* TOPBAR */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:14px 10px 6px;
    }

    .logo{
      width:42px;
      height:42px;
      border-radius:50%;
      overflow:hidden;
      border:1px solid var(--border);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }

    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .title{
      font-size:14px;
      letter-spacing:.18em;
      color:var(--muted);
      text-transform:uppercase;
    }

    .card{
      margin-top:10px;
      background:rgba(20,20,20,.90);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .screen{
      padding:18px 16px 16px;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:10px;
      margin-bottom:18px;
    }

    .tab{
      flex:1;
      padding:14px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0f0f0f;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .tab small{
      display:block;
      margin-top:4px;
      font-size:12px;
      font-weight:700;
      letter-spacing:.06em;
      color:#7b8596;
    }

    .tab.active{
      border-color:var(--accent);
      color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,197,94,.4);
    }
    .tab.active small{ color:#a8ffcb; }

    /* PANELS */
    .panel{ display:none; }
    .panel.active{ display:block; }

    .hero{
      text-align:center;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      padding:6px 0 6px;
    }

    .iconBox{
      width:82px;
      height:82px;
      border-radius:24px;
      border:1px solid var(--border);
      background:linear-gradient(180deg,#1d1d1d,#101010);
      display:grid;
      place-items:center;
      font-size:34px;
      margin-top:4px;
    }

    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.02em;
    }

    .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:360px;
      margin:0 auto;
      text-transform:uppercase;
    }

    .tip{
      color:#7b8596;
      font-size:12px;
      margin-top:-4px;
      text-transform:uppercase;
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
      margin-top:14px;
    }

    button{
      border:0;
      border-radius:16px;
      padding:16px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      letter-spacing:.02em;
    }

    .primary{
      background:var(--accent);
      color:#06230f;
    }

    .secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }

    .status{
      margin-top:14px;
      padding:12px 14px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      text-align:center;
      text-transform:uppercase;
    }

    /* FORMS */
    .form{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:10px;
    }

    label{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    input{
      width:100%;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0f0f0f;
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    input::placeholder{ color:#6b7280; }

    .miniRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .miniRow button{ width:100%; }

    /* TAGS */
    .sectionTitle{
      margin:14px 0 8px;
      font-weight:900;
      letter-spacing:.08em;
      color:var(--muted);
      text-transform:uppercase;
      font-size:12px;
      text-align:left;
    }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .tag{
      border:1px solid var(--border);
      background:#0f0f0f;
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      text-transform:uppercase;
    }
    .tag.on{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(34,197,94,.35);
      color:var(--accent);
    }

    /* RESULTS */
    .resultsWrap{
      margin-top:14px;
      border-top:1px solid var(--border);
      padding-top:14px;
    }

    .resultsHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .resultsHead .left{
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
      color:var(--muted);
    }

    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:#0f0f0f;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    .prod{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:#0f0f0f;
      cursor:pointer;
    }

    .prod img{
      width:100%;
      height:140px;
      object-fit:cover;
      display:block;
      background:#111;
    }

    .prod .pbody{
      padding:10px;
    }

    .prod .ptitle{
      font-weight:900;
      font-size:13px;
      line-height:1.2;
      margin:0 0 6px;
      text-transform:uppercase;
    }

    .prod .plink{
      color:var(--accent);
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
      opacity:.95;
    }

    .notice{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      text-transform:uppercase;
    }

    @media (max-width:420px){
      .grid{ grid-template-columns:1fr; }
      .prod img{ height:170px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOP -->
    <div class="topbar">
      <div class="logo">
        <img src="logo-canaris.png" alt="Canaris">
      </div>
      <div class="title">ASSISTENTE CANARIS</div>
    </div>

    <div class="card">
      <div class="screen">

        <!-- TABS -->
        <div class="tabs">
          <div class="tab active" data-tab="foto">FOTO<small>SCATTA / CARICA</small></div>
          <div class="tab" data-tab="codice">CODICE<small>CERCA PER TAG</small></div>
          <div class="tab" data-tab="filtri">FILTRI<small>TAG RAPIDI</small></div>
        </div>

        <!-- FOTO -->
        <div class="panel active" id="panel-foto">
          <div class="hero">
            <div class="iconBox">üì∑</div>

            <h1>TROVA ABITI SIMILI</h1>
            <p class="sub">
              SCATTA UNA FOTO DELL‚ÄôABITO (APPESO, MANICHINO O INDOSSATO). POI TI MOSTRA I PI√ô SIMILI DISPONIBILI.
            </p>
            <div class="tip">TIP: INQUADRA L‚ÄôABITO INTERO, SENZA SFONDI TROPPO CAOTICI.</div>

            <div class="actions">
              <button class="primary" id="btn-scatta">üì∏ SCATTA FOTO</button>
              <button class="secondary" id="btn-galleria">üìÅ CARICA DALLA GALLERIA</button>
            </div>

            <input id="input-camera" type="file" accept="image/*" capture="environment" hidden>
            <input id="input-gallery" type="file" accept="image/*" hidden>
          </div>

          <div class="resultsWrap" id="foto-results" style="display:none;">
            <div class="resultsHead">
              <div class="left">RISULTATI (DEMO)</div>
              <div class="pill" id="foto-pill">DEMO</div>
            </div>
            <div class="notice">
              MODALIT√Ä FOTO: UI PRONTA. DOPO COLLEGHIAMO STYLE AI PER IL ‚ÄúSIMILE‚Äù REALE.
            </div>
          </div>

          <div class="status">STATO: PRONTA (DEMO ‚Äî POI COLLEGHIAMO SHOPIFY + STYLE AI)</div>
        </div>

        <!-- CODICE -->
        <div class="panel" id="panel-codice">
          <div class="hero">
            <div class="iconBox">üîé</div>

            <h1>CERCA PER CODICE</h1>
            <p class="sub">
              INSERISCI IL CODICE DELL‚ÄôETICHETTA. IL CODICE √à UN TAG SU SHOPIFY.
            </p>
          </div>

          <div class="form">
            <label for="codeInput">CODICE ETICHETTA (TAG)</label>
            <input id="codeInput" placeholder="ES. T00251" autocomplete="off" />

            <div class="miniRow">
              <button class="primary" id="btn-code">CERCA</button>
              <button class="secondary" id="btn-code-clear">PULISCI</button>
            </div>
          </div>

          <div class="resultsWrap" id="code-results" style="display:none;">
            <div class="resultsHead">
              <div class="left">RISULTATI SHOPIFY</div>
              <div class="pill" id="code-pill">0 TROVATI</div>
            </div>
            <div class="grid" id="code-grid"></div>
            <div class="notice" id="code-empty" style="display:none; margin-top:10px;">
              NESSUN RISULTATO. CONTROLLA CHE IL TAG SIA IDENTICO AL CODICE INSERITO.
            </div>
          </div>

          <div class="status">STATO: PRONTA (MODALIT√Ä: CODICE)</div>
        </div>

        <!-- FILTRI -->
        <div class="panel" id="panel-filtri">
          <div class="hero">
            <div class="iconBox">üéõÔ∏è</div>

            <h1>FILTRI RAPIDI</h1>
            <p class="sub">
              SELEZIONA 1‚Äì3 TAG (LINEA, LUNGHEZZA, SCOLLO). POI TI MOSTRA GLI ABITI.
            </p>
          </div>

          <div class="sectionTitle">LINEA</div>
          <div class="tags">
            <div class="tag">MORBIDO</div>
            <div class="tag">SCIVOLATO</div>
            <div class="tag">SIRENA</div>
            <div class="tag">AMPIO</div>
            <div class="tag">TUBO</div>
            <div class="tag">CORTOAVANTI LUNGO DIETRO</div>
          </div>

          <div class="sectionTitle">LUNGHEZZA</div>
          <div class="tags">
            <div class="tag">ABITI CORTI</div>
            <div class="tag">ABITI LUNGHI</div>
          </div>

          <div class="sectionTitle">SCOLLO</div>
          <div class="tags">
            <div class="tag">A V</div>
            <div class="tag">OMERALE</div>
            <div class="tag">BRETELLA LARGA</div>
            <div class="tag">CUORE</div>
            <div class="tag">FASCIA</div>
          </div>

          <div class="actions" style="margin-top:18px;">
            <button class="primary" id="btn-filtri">TROVA</button>
            <button class="secondary" id="btn-reset">RESET</button>
          </div>

          <div class="resultsWrap" id="tag-results" style="display:none;">
            <div class="resultsHead">
              <div class="left">RISULTATI SHOPIFY</div>
              <div class="pill" id="tag-pill">0 TROVATI</div>
            </div>
            <div class="grid" id="tag-grid"></div>
            <div class="notice" id="tag-empty" style="display:none; margin-top:10px;">
              NESSUN RISULTATO. TAG NON PRESENTI O NON COMBACIANO.
            </div>
          </div>

          <div class="status">STATO: PRONTA (MODALIT√Ä: FILTRI)</div>
        </div>

      </div>
    </div>

  </div>

  <script>
    /* =========================
       CONFIG SHOPIFY
       ========================= */
    const SHOP_DOMAIN = "charmecanaris.it";
    const STOREFRONT_TOKEN = "e94f7ce2cd0da2ee9f57e32f65af1f40";
    const API_VERSION = "2024-10";

    async function shopifyGraphQL(query) {
      const res = await fetch(`https://${SHOP_DOMAIN}/api/${API_VERSION}/graphql.json`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Shopify-Storefront-Access-Token": STOREFRONT_TOKEN
        },
        body: JSON.stringify({ query })
      });

      const data = await res.json();
      if (data.errors) console.error("SHOPIFY ERRORS:", data.errors);
      return data;
    }

    function escapeForGraphQL(str) {
      return String(str)
        .replaceAll("\\", "\\\\")
        .replaceAll('"', '\\"')
        .replaceAll("\n", " ")
        .trim();
    }

    async function fetchProductsBySearch(searchString) {
      const q = `
        query {
          products(first: 10, query: "${escapeForGraphQL(searchString)}") {
            edges {
              node {
                id
                title
                handle
                tags
                images(first: 1) { edges { node { url } } }
              }
            }
          }
        }
      `;
      const data = await shopifyGraphQL(q);
      const edges = data?.data?.products?.edges || [];
      return edges.map(e => e.node);
    }

    function renderProducts(gridEl, products) {
      gridEl.innerHTML = "";
      products.forEach(p => {
        const img = p?.images?.edges?.[0]?.node?.url || "";
        const card = document.createElement("div");
        card.className = "prod";
        card.innerHTML = `
          ${img ? `<img src="${img}" alt="">` : `<img src="" alt="" style="opacity:.15">`}
          <div class="pbody">
            <p class="ptitle">${p.title}</p>
            <div class="plink">APRI PRODOTTO</div>
          </div>
        `;
        card.addEventListener("click", () => {
          window.open(`https://${SHOP_DOMAIN}/products/${p.handle}`, "_blank");
        });
        gridEl.appendChild(card);
      });
    }

    /* =========================
       UI: TABS
       ========================= */
    const tabs = document.querySelectorAll(".tab");
    const panels = {
      foto: document.getElementById("panel-foto"),
      codice: document.getElementById("panel-codice"),
      filtri: document.getElementById("panel-filtri")
    };

    tabs.forEach(t => {
      t.addEventListener("click", () => {
        tabs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const name = t.dataset.tab;

        Object.values(panels).forEach(p => p.classList.remove("active"));
        panels[name].classList.add("active");
      });
    });

    /* =========================
       FOTO: DEMO INPUT
       ========================= */
    const inputCamera = document.getElementById("input-camera");
    const inputGallery = document.getElementById("input-gallery");
    const btnScatta = document.getElementById("btn-scatta");
    const btnGalleria = document.getElementById("btn-galleria");

    btnScatta.addEventListener("click", () => inputCamera.click());
    btnGalleria.addEventListener("click", () => inputGallery.click());

    function handlePhoto(file) {
      if (!file) return;
      document.getElementById("foto-results").style.display = "block";
      document.getElementById("foto-pill").textContent = "DEMO";
      console.log("FOTO CARICATA:", file.name, file.size);
    }

    inputCamera.addEventListener("change", (e) => handlePhoto(e.target.files?.[0]));
    inputGallery.addEventListener("change", (e) => handlePhoto(e.target.files?.[0]));

    /* =========================
       CODICE: CERCA SOLO PER TAG
       ========================= */
    const codeInput = document.getElementById("codeInput");
    const btnCode = document.getElementById("btn-code");
    const btnCodeClear = document.getElementById("btn-code-clear");
    const codeResults = document.getElementById("code-results");
    const codeGrid = document.getElementById("code-grid");
    const codePill = document.getElementById("code-pill");
    const codeEmpty = document.getElementById("code-empty");

    btnCodeClear.addEventListener("click", () => {
      codeInput.value = "";
      codeResults.style.display = "none";
      codeGrid.innerHTML = "";
      codeEmpty.style.display = "none";
    });

    btnCode.addEventListener("click", async () => {
      const code = codeInput.value.trim();
      if (!code) return;

      codeResults.style.display = "block";
      codePill.textContent = "CERCO...";
      codeEmpty.style.display = "none";
      codeGrid.innerHTML = "";

      const search = `tag:${code}`;
      const products = await fetchProductsBySearch(search);

      codePill.textContent = `${products.length} TROVATI`;

      if (!products.length) {
        codeEmpty.style.display = "block";
        return;
      }

      renderProducts(codeGrid, products);
    });

    /* =========================
       FILTRI: TAG + RICERCA SHOPIFY
       ========================= */
    const tagBlocks = document.querySelectorAll(".tag");
    const btnFiltri = document.getElementById("btn-filtri");
    const btnReset = document.getElementById("btn-reset");

    const tagResults = document.getElementById("tag-results");
    const tagGrid = document.getElementById("tag-grid");
    const tagPill = document.getElementById("tag-pill");
    const tagEmpty = document.getElementById("tag-empty");

    tagBlocks.forEach(tag => {
      tag.addEventListener("click", () => tag.classList.toggle("on"));
    });

    btnReset.addEventListener("click", () => {
      tagBlocks.forEach(t => t.classList.remove("on"));
      tagResults.style.display = "none";
      tagGrid.innerHTML = "";
      tagEmpty.style.display = "none";
    });

    btnFiltri.addEventListener("click", async () => {
      const selected = Array.from(tagBlocks)
        .filter(t => t.classList.contains("on"))
        .map(t => t.textContent.trim());

      tagResults.style.display = "block";
      tagPill.textContent = "CERCO...";
      tagEmpty.style.display = "none";
      tagGrid.innerHTML = "";

      if (selected.length === 0) {
        tagPill.textContent = "0 TROVATI";
        tagEmpty.style.display = "block";
        tagEmpty.textContent = "SELEZIONA ALMENO 1 TAG.";
        return;
      }

      const search = selected.map(t => `tag:${t}`).join(" AND ");
      const products = await fetchProductsBySearch(search);

      tagPill.textContent = `${products.length} TROVATI`;

      if (!products.length) {
        tagEmpty.style.display = "block";
        tagEmpty.textContent = "NESSUN RISULTATO. (TAG NON PRESENTI O NON COMBACIANO)";
        return;
      }

      renderProducts(tagGrid, products);
    });

    console.log("ASSISTENTE CANARIS OK. MODALIT√Ä CODICE = TAG.");
  </script>
</body>
</html>
